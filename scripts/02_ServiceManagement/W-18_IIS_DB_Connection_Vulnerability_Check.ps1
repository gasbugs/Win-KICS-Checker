# IIS 관리 모듈 가져오기
Import-Module WebAdministration

$result = @{
    CheckItem = "W-18"
    Category = "Service Management"
    Result = "Good"
    Details = "No vulnerable .asa handler mappings found."
    Timestamp = (Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
}

try {
    $vulnerableSites = @()
    $sites = Get-Website

    foreach ($site in $sites) {
        <# Skip non-HTTP sites
        $isHttpSite = $false
        foreach($binding in $site.bindings.collection) {
            if($binding.protocol -like "http *") {
                $isHttpSite = $true
                break
            }
        } 
        if (-not $isHttpSite) {
            continue
        } #>
        

        $siteName = $site.Name
        # 각 사이트의 .asa 처리기 매핑 경로 설정
        $handlerPath = "IIS:\Sites\$siteName"
        
        try {
            $asaHandler = Get-WebConfigurationProperty -pspath $handlerPath -filter "system.webServer/handlers/add[@path='*.asa']" -name "."
            $asaxHandler = Get-WebConfigurationProperty -pspath $handlerPath -filter "system.webServer/handlers/add[@path='*.asax']" -name "."
            # .asa 매핑이 여러 개 있을 수 있으므로 반복 처리
            foreach ($handler in $asaHandler) {
                # verb 속성 값 확인
                $verbs = $handler.verb
                if ($verbs -eq "*") {
                    #Write-Host "[$siteName] 사이트: .asa 매핑이 모든 동작(*)을 허용합니다. [취약]" -ForegroundColor Red
                    $vulnerableSites += $siteName
                } else {
                    #Write-Host "[$siteName] 사이트: .asa 매핑이 특정 동작($verbs)으로 제한되어 있습니다. [양호]" -ForegroundColor Green
                }
            }
            foreach ($handler in $asaxHandler) {
                # verb 속성 값 확인
                $verbs = $handler.verb
                if ($verbs -eq "*") {
                    #Write-Host "[$siteName] 사이트: .asax 매핑이 모든 동작(*)을 허용합니다. [취약]" -ForegroundColor Red
                    $vulnerableSites += $siteName
                } else {
                    #Write-Host "[$siteName] 사이트: .asax 매핑이 특정 동작($verbs)으로 제한되어 있습니다. [양호]" -ForegroundColor Green
                }
            }
        } catch {
            # Ignore errors for a single site, continue with the next one
        }
    }

    if ($vulnerableSites.Count -gt 0) {
        $result.Result = "Vulnerable"
        $result.Details = "The following sites have a vulnerable .asa handler mapping allowing all verbs (*): $($vulnerableSites -join ', ')"
    }

} catch {
    $result.Result = "Error"
    $result.Details = "An error occurred during the .asa handler mapping check: $($_.Exception.Message)"
}

$result | ConvertTo-Json -Depth 100