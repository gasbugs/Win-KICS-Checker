# `run_all_diagnostics.ps1` 변경 로그

이 문서는 `run_all_diagnostics.ps1` 스크립트에 대한 주요 변경 사항(버그 수정, 성능 개선, 기능 추가 포함)을 설명합니다.

## 변경 사항 요약

### 17. 진단 스크립트 요약 기능 추가 및 테스트 환경 개선 (2025-09-14)

*   **진단 결과 요약 기능 추가:**
    *   **내용:** `run_all_diagnostics.ps1` 및 `run_all_diag_local.ps1` 스크립트 실행 완료 후, 진단 결과(취약, 양호, 수동 확인 필요, 해당 없음, 오류)에 대한 요약 통계를 콘솔에 출력하도록 기능을 추가했습니다.
*   **테스트 환경 W-07 취약점 구성:**
    *   **내용:** `test_env/provisioning/install_applications.ps1` 스크립트에 `Configure-VulnerableShare` 함수를 추가하여, W-07 항목(공유 권한 설정)을 취약하게 구성하는 기능을 구현했습니다.
    *   **수정:** `New-WebFtpSite` 명령어 실행 시 이미 존재하는 경우 오류가 발생하던 문제를 `-Force` 매개변수 추가로 해결하여 멱등성을 확보했습니다.
*   **라이선스 파일 생성:**
    *   **내용:** 프로젝트의 상업적 이용 안내를 포함하는 `license.md` 파일을 생성했습니다.

### 16. FTP 진단 기능 개선 및 프로비저닝 스크립트 리팩토링 (2025-09-14)

*   **FTP 진단 로직 개선:**
    *   **문제:** 기존 FTP 진단 스크립트(W-26, W-27, W-28)는 IIS 관리 도구(WebAdministration 모듈)에 의존하여, 해당 도구가 없거나 FTP 사이트가 구성되지 않은 경우 정확한 진단이 어려웠습니다.
    *   **해결책:** IIS 설정 파일(`applicationHost.config`)을 직접 XML로 분석하여 FTP 사이트 설정을 확인하도록 로직을 전면 수정했습니다. 이를 통해 PowerShell 모듈 의존성을 제거하고, 서비스 실행 여부와 사이트 구성 상태를 더 정확하게 진단할 수 있게 되었습니다.
*   **로컬 진단 스크립트 추가:**
    *   **내용:** 원격 연결 없이 현재 시스템을 직접 진단하는 `run_all_diag_local.ps1` 스크립트를 추가했습니다.
*   **프로비저닝 스크립트 리팩토링:**
    *   **내용:** `test_env/provisioning/install_applications.ps1` 스크립트를 기능별 함수(WinRM 설정, 기능 설치, FTP 사이트 구성 등)로 분리하고, 에러 핸들링 및 가독성을 개선하여 리팩토링했습니다.
    *   **수정:** `New-FtpSite`가 아닌 정확한 명령어 `New-WebFtpSite`를 사용하도록 수정했습니다.

### 15. 스크립트 실행 오류 수정 (2025-09-13)

*   **문제:** `run_all_diagnostics.ps1` 실행 시, 이전 버전의 `W-40` 및 `W-60` 스크립트 경로가 남아있어 "파일을 찾을 수 없음" 경고가 발생했습니다.
    *   **해결책:** 메인 스크립트(`run_all_diagnostics.ps1`)의 스크립트 목록에서 존재하지 않는 두 개의 옛 경로를 제거하여 경고를 해결했습니다.

*   **문제:** FTP 기능이 설치되지 않은 시스템에서 `W-26`, `W-27`, `W-28` 스크립트 실행 시 `Get-FtpSite` cmdlet을 찾지 못해 'Error'가 발생했습니다.
    *   **해결책:** 세 스크립트 시작 부분에 `Get-Command`를 사용하여 `Get-FtpSite` 명령어의 존재 여부를 먼저 확인하도록 수정했습니다. 명령어가 없는 경우, 결과를 'Not Applicable'로 처리하여 오류를 방지합니다.

### 9. 진단 스크립트 추가 및 실행 확인 (2025-09-13)

*   **내용:** `scripts/02_ServiceManagement/` 경로에 W-25부터 W-30까지의 진단 스크립트가 `run_all_diagnostics.ps1`에 통합되었습니다.
    *   **확인:** `vagrant/vagrant` 자격 증명을 사용하여 `127.0.0.1:5986` 대상에 대한 전체 진단 스크립트 실행이 성공적으로 완료되었습니다.

### 10. W-31 새 점검 구현 (2025-09-13)

*   **문제:** 최신 서비스팩 적용 여부를 확인하는 `W-31` 점검 추가 요청.
    *   **해결책:** `scripts/02_ServiceManagement/W-31_Latest_Service_Pack_Application.ps1` 스크립트를 생성하고 메인 스크립트에 통합했습니다.

### 11. 추가 진단 스크립트 구현 (2025-09-13)

*   **01_AccountManagement:** W-46, W-47, W-48, W-49, W-50, W-51, W-52, W-53, W-54, W-55, W-56, W-57 스크립트가 추가되었습니다.
*   **02_ServiceManagement:** W-58, W-59, W-60, W-61, W-62, W-63, W-64, W-65, W-66, W-67, W-68 스크립트가 추가되었습니다.
*   **03_PatchManagement:** W-32, W-33, W-69 스크립트가 추가되었습니다.
*   **04_LogManagement:** W-34, W-35, W-70, W-71 스크립트가 추가되었습니다.

### 12. 보안 관리 진단 스크립트 구현 (2025-09-13)

*   **05_SecurityManagement:** W-36, W-37, W-38, W-39, W-40, W-41, W-42, W-43, W-44, W-45, W-72, W-73, W-74, W-75, W-76, W-77, W-78, W-79, W-80, W-81 스크립트가 추가되었습니다.

### 13. 보안 관리 진단 스크립트 추가 (2025-09-13)

*   **05_SecurityManagement:** W-82 스크립트가 추가되었습니다.

### 14. 스크립트 오류 수정 (2025-09-13)

*   **W-45:** `Get-BitLockerVolume` 대신 `Win32_EncryptableVolume` WMI 클래스를 사용하도록 수정되었습니다.
*   **W-79:** `Get-Volume -DriveType Fixed` 대신 `Win32_LogicalDisk` WMI 클래스를 사용하도록 수정되었습니다.
*   **W-81:** 레지스트리 키 속성 접근 방식이 `PSObject` 오류를 피하도록 수정되었습니다.

### 1. WinRM 연결 및 PowerShell 호환성 개선

*   **문제:** 이전 PowerShell 버전에서 `AllowUnencrypted` 및 `UseSSL` 매개변수 문제로 WinRM 연결이 실패했습니다.
    *   **해결책:** `New-PSSessionOption`에서 해당 매개변수를 제거하고, `Invoke-Command`에 `ConnectionUri`를 사용하여 HTTPS 연결을 명시했습니다. SSL 인증서 검사 건너뛰기 옵션(`-SkipCACheck -SkipCNCheck`)을 재도입했습니다.

### 2. 변수 참조 오류 수정

*   **문제:** `Write-Host` 및 `ComputerName` 구성에서 잘못된 변수 참조로 인해 구문 오류가 발생했습니다.
    *   **해결책:** 중괄호 `${}`를 사용하여 변수 이름을 명시적으로 구분했습니다.

### 3. 실행 속도 개선 (단일 PSSession 사용)

*   **문제:** 각 진단 스크립트마다 새로운 원격 PowerShell 세션을 설정하여 실행 속도가 느렸습니다.
    *   **해결책:** 스크립트 시작 시 단일 PSSession을 생성하고, 모든 `Invoke-Command` 호출이 이 세션을 재사용하도록 변경하여 오버헤드를 줄였습니다.

### 4. 추가 실행 속도 개선 (결합된 스크립트 블록)

*   **문제:** 단일 PSSession 내에서도 개별 스크립트 실행으로 인한 오버헤드가 존재했습니다.
    *   **해결책:** 모든 진단 스크립트 내용을 단일 PowerShell 스크립트 블록으로 결합하여 원격 컴퓨터에서 한 번만 실행하도록 변경했습니다. 이는 네트워크 트래픽 및 `Invoke-Command` 오버헤드를 최소화합니다.

### 5. 한글 번역 및 CSV 출력 기능 (되돌림)

*   **문제:** 한글 번역 및 CSV 파일 생성 시 인코딩 및 `ConvertTo-Csv` 오류가 발생했습니다.
    *   **해결책:** 한글 번역 관련 기능을 모두 제거하고, 영어로 된 표준 CSV 출력을 생성하도록 되돌렸습니다.

### 6. W-07 오류 해결 (SmbShare 모듈 로드)

*   **문제:** `W-07` 점검 시 `SmbShare` 모듈 로드 오류가 발생했습니다.
    *   **해결책:** `Import-Module SmbShare -ErrorAction SilentlyContinue`를 추가하여 모듈이 로드되도록 했습니다.

### 7. W-21 새 점검 구현

*   **문제:** 사용하지 않는 IIS 스크립트 매핑을 확인하는 `W-21` 점검 추가 요청.
    *   **해결책:** `scripts/02_ServiceManagement/W-21_IIS_Unused_Script_Mapping_Removal.ps1` 스크립트를 생성하고 메인 스크립트에 통합했습니다.

### 8. W-15 오류 해결 (Get-IISAppPool 사용)

*   **문제:** `W-15` 점검 시 `Get-WebAppPool`이 인식되지 않아 오류가 발생했습니다.
    *   **해결책:** `W-15` 스크립트를 `Get-IISAppPool`을 사용하도록 재작성했습니다. `Get-IISAppPool`이 작동하지 않을 경우 `appcmd.exe`를 시도하며, 모든 시도가 실패하면 "수동 점검 필요"를 보고합니다.

## 스크립트 실행 방법

`run_all_diagnostics.ps1` 스크립트를 실행하려면 PowerShell을 열고 스크립트 디렉토리로 이동합니다. 그런 다음 다음 명령을 실행합니다.

```powershell
powershell.exe -File ".\run_all_diagnostics.ps1" -ComputerName "127.0.0.1" -Port 5986 -Username "vagrant" -Password "vagrant"
```

**중요 참고 사항:**

*   **WinRM 구성:** 클라이언트(이 스크립트를 실행하는 컴퓨터)와 대상 컴퓨터(127.0.0.1) 모두에서 WinRM이 활성화되고 구성되었는지 확인하십시오.
*   **암호화되지 않은 트래픽(HTTP 사용 시):** WinRM에 HTTP(포트 5985)를 사용하려는 경우, 이 스크립트를 실행하는 컴퓨터의 WinRM 클라이언트가 암호화되지 않은 트래픽을 허용하도록 구성해야 할 수 있습니다. 이는 관리자 권한으로 다음을 사용하여 수행할 수 있습니다.
    ```powershell
winrm set winrm/config/client @{AllowUnencrypted="true"}
    ```
    그러나 스크립트는 현재 HTTPS(포트 5986)용으로 구성되어 있습니다.
*   **HTTPS (포트 5986):** HTTPS 연결의 경우, 대상 컴퓨터에 5986 포트에서 WinRM용 유효한 SSL 인증서가 구성되었는지 확인하십시오. 스크립트는 테스트 목적으로 인증 기관 및 일반 이름 확인(`-SkipCACheck -SkipCNCheck`)을 건너뛰도록 구성되어 있습니다. 이는 보안에 취약하며 위험을 이해하지 않고는 프로덕션 환경에서 사용해서는 안 됩니다.
*   **관리자 권한:** 이 스크립트를 실행하고 WinRM을 구성하려면 종종 관리자 권한이 필요합니다.
*   **Excel의 CSV 인코딩:** Microsoft Excel에서 생성된 CSV를 열 때 인코딩 문제가 발생하는 경우, Excel의 "데이터" 탭 -> "텍스트/CSV에서" 옵션을 사용하여 데이터를 가져오고 파일 원본으로 "UTF-8"을 수동으로 선택해 보십시오.

### 일반 사용법 참고 사항

*   **문서 참조:** 새로운 검사 또는 기능을 구현하도록 요청받을 때마다 관련 정보 및 컨텍스트에 대해 항상 `docs` 디렉토리를 참조하십시오. 제공된 문서에서 찾을 수 있을 가능성이 있는 세부 정보를 요청할 필요는 없습니다.
*   **CSV에 나열된 정보 포함:** 수동 진단이 필요한 경우, 해당 점검에서 나열된 상세 정보(예: 계정 목록, 그룹 구성원)는 CSV 보고서의 해당 `Details` 필드에 포함됩니다. 자세한 내용은 `docs`를 참조하십시오.
